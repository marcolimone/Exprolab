<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scripts.my_state_machine &mdash; FSM_Robot_Assognment_1 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> FSM_Robot_Assognment_1
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FSM_Robot_Assognment_1</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">scripts.my_state_machine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scripts.my_state_machine</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: state machine</span>
<span class="sd">   :platform: Unix</span>
<span class="sd">   :synopsis: Python module for the state machine</span>
<span class="sd">.. moduleauthor:: Marco Limone</span>
<span class="sd"> </span>
<span class="sd">This node run the state machine the execute function of each state describe what happened in each state </span>

<span class="sd">Param:</span>
<span class="sd"> /battery_flag to know when the battery have to start to charge or discharge</span>
<span class="sd"> /controller_flag to activate and deactivate the controller</span>
<span class="sd"> /planner_flag</span>

<span class="sd">Subsciber to:</span>

<span class="sd"> /battery</span>
<span class="sd"> /create_map</span>
<span class="sd"> /planner</span>
<span class="sd"> /controller</span>
<span class="sd"> </span>
<span class="sd">&quot;&quot;&quot;</span>



<span class="kn">import</span> <span class="nn">roslib</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">smach</span>
<span class="kn">import</span> <span class="nn">smach_ros</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Bool</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Float64</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Lock</span>
<span class="kn">import</span> <span class="nn">threading</span>


<span class="n">BATTERY_LOW</span> <span class="o">=</span> <span class="s1">&#39;battery_low&#39;</span>
<span class="n">END_MAP</span> <span class="o">=</span> <span class="s1">&#39;endmap&#39;</span>
<span class="n">PLAN_OK</span> <span class="o">=</span> <span class="s1">&#39;plan_ok&#39;</span>
<span class="n">ARRIVED</span> <span class="o">=</span> <span class="s1">&#39;arrived&#39;</span>
<span class="n">END_TIME</span> <span class="o">=</span> <span class="s1">&#39;endtime&#39;</span>
<span class="n">BATTERY_OK</span> <span class="o">=</span> <span class="s1">&#39;battery_ok&#39;</span>


<div class="viewcode-block" id="Helper"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Helper">[docs]</a><span class="k">class</span> <span class="nc">Helper</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class that allow the use of mutex and contain all the callback of the subscribers </span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">done_callback</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">feedback_callback</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mutex</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;battery&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batterylowCallback</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;send_map&quot;</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildingmapCallback</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;planner&quot;</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plannerCallback</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;controller&quot;</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">controllerCallback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mutex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">mutex</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span> <span class="o">=</span> <span class="n">BATTERY_OK</span>    

<div class="viewcode-block" id="Helper.batterylowCallback"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Helper.batterylowCallback">[docs]</a>    <span class="k">def</span> <span class="nf">batterylowCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:String return the status of the battery</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">BATTERY_LOW</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span> <span class="o">=</span> <span class="n">BATTERY_LOW</span>
           <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">BATTERY_LOW</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">BATTERY_OK</span><span class="p">:</span>  
           <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span> <span class="o">=</span> <span class="n">BATTERY_OK</span>
           <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">BATTERY_OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>
        
           
<div class="viewcode-block" id="Helper.buildingmapCallback"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Helper.buildingmapCallback">[docs]</a>    <span class="k">def</span> <span class="nf">buildingmapCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:Bool this value is true when the building of the map is end</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span> <span class="o">=</span> <span class="n">END_MAP</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
           <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">END_MAP</span><span class="p">)</span> </div>
           
<div class="viewcode-block" id="Helper.plannerCallback"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Helper.plannerCallback">[docs]</a>    <span class="k">def</span> <span class="nf">plannerCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:Bool this value is true when the planner send a plan</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span> <span class="o">=</span> <span class="n">PLAN_OK</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
           <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">PLAN_OK</span><span class="p">)</span>        </div>
     
<div class="viewcode-block" id="Helper.controllerCallback"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Helper.controllerCallback">[docs]</a>    <span class="k">def</span> <span class="nf">controllerCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:Bool this value is true when the controller node brings the robot in the right room</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">change_state</span> <span class="o">=</span> <span class="n">ARRIVED</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
           <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">ARRIVED</span><span class="p">)</span>                   </div></div>



<span class="c1"># define state Building_map</span>
<div class="viewcode-block" id="Building_map"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Building_map">[docs]</a><span class="k">class</span> <span class="nc">Building_map</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class describe what happen when the state machine is in the Building_map state, the state machine exit from this state when the ontology is finish.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;endmap&#39;</span><span class="p">,</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span> <span class="s1">&#39;plan_ok&#39;</span><span class="p">,</span> <span class="s1">&#39;arrived&#39;</span><span class="p">,</span> <span class="s1">&#39;endtime&#39;</span><span class="p">,</span> <span class="s1">&#39;battery_ok&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unlocked_counter_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unlocked_counter_out&#39;</span><span class="p">])</span>
        
<div class="viewcode-block" id="Building_map.execute"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Building_map.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
                  
                  <span class="k">try</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">BATTERY_LOW</span><span class="p">:</span>
                         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span>
                      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">END_MAP</span><span class="p">:</span> 
                         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span>
                         
                      <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Building_map&#39;</span><span class="p">)</span>
                  <span class="k">finally</span><span class="p">:</span>    
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                  <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>    </div></div>
    

<span class="c1"># define state Planner</span>
<div class="viewcode-block" id="Planner"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Planner">[docs]</a><span class="k">class</span> <span class="nc">Planner</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class describe what happen when the state machine is in the Planner state, to exit from this state the robot need to choose the room where the robot have to go.</span>
<span class="sd">    Another way to exit from this state is when arrive the message of battery low.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;endmap&#39;</span><span class="p">,</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span> <span class="s1">&#39;plan_ok&#39;</span><span class="p">,</span> <span class="s1">&#39;arrived&#39;</span><span class="p">,</span> <span class="s1">&#39;endtime&#39;</span><span class="p">,</span> <span class="s1">&#39;battery_ok&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;locked_counter_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;locked_counter_out&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="Planner.execute"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Planner.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/battery_flag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/controller_flag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/planner_flag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/arrived_in_E&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
                  <span class="k">try</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">BATTERY_LOW</span><span class="p">:</span>
                         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span>
                      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">PLAN_OK</span><span class="p">:</span>
                         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span>
                      <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Planner&#39;</span><span class="p">)</span>
                  <span class="k">finally</span><span class="p">:</span>    
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                  <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span> 
                  <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Planner&#39;</span><span class="p">)</span></div></div>
              
    
<span class="c1"># define state Controller</span>
<div class="viewcode-block" id="Controller"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Controller">[docs]</a><span class="k">class</span> <span class="nc">Controller</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class describe what happen when the state machine is in the Controller state, to exit from this state the robot need to reach the desired room.</span>
<span class="sd">    Another way to exit from this state is when arrive the message of battery low.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;endmap&#39;</span><span class="p">,</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span> <span class="s1">&#39;plan_ok&#39;</span><span class="p">,</span> <span class="s1">&#39;arrived&#39;</span><span class="p">,</span> <span class="s1">&#39;endtime&#39;</span><span class="p">,</span> <span class="s1">&#39;battery_ok&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unlocked_counter_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unlocked_counter_out&#39;</span><span class="p">])</span>
        
<div class="viewcode-block" id="Controller.execute"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Controller.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/planner_flag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/controller_flag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
                  
                  <span class="k">try</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">BATTERY_LOW</span><span class="p">:</span>
                         <span class="k">return</span> <span class="n">BATTERY_LOW</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">ARRIVED</span><span class="p">:</span>
                         <span class="k">return</span> <span class="n">ARRIVED</span>
                      <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Controller&#39;</span><span class="p">)</span>
                  <span class="k">finally</span><span class="p">:</span>   
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                  <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span> </div></div>
        
        

<span class="c1"># define state Wait</span>
<div class="viewcode-block" id="Wait"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Wait">[docs]</a><span class="k">class</span> <span class="nc">Wait</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class describe what happen when the state machine is in the Wait state, to exit from this state the robot need turn its camera around, at the end of this motion the state machine can change state.</span>
<span class="sd">    Another way to exit from this state is when arrive the message of battery low.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;endmap&#39;</span><span class="p">,</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span> <span class="s1">&#39;plan_ok&#39;</span><span class="p">,</span> <span class="s1">&#39;arrived&#39;</span><span class="p">,</span> <span class="s1">&#39;endtime&#39;</span><span class="p">,</span> <span class="s1">&#39;battery_ok&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;locked_counter_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;locked_counter_out&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="Wait.execute"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Wait.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/planner_flag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;rob/joint1_position_controller/command&#39;</span><span class="p">,</span> <span class="n">Float64</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/controller_flag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rotation</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">rotation_flag</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">finish</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
                  <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>
                  <span class="k">try</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">BATTERY_LOW</span><span class="p">:</span>
                         <span class="n">rotation</span><span class="o">=</span><span class="mf">0.0</span>
                         <span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
                         <span class="k">return</span> <span class="n">BATTERY_LOW</span>
                         <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Wait&#39;</span><span class="p">)</span>
                      <span class="k">elif</span>  <span class="n">finish</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">=</span> <span class="n">END_TIME</span>
                         <span class="k">return</span> <span class="n">END_TIME</span>
                         <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Wait&#39;</span><span class="p">)</span>   
                  <span class="k">finally</span> <span class="p">:</span>   
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                  <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                  <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Wait&#39;</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">rotation</span> <span class="o">&gt;=</span><span class="mf">6.28</span><span class="p">:</span>
                     <span class="n">rotation_flag</span> <span class="o">=</span> <span class="mi">1</span>
                  <span class="k">elif</span> <span class="n">rotation</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                     <span class="n">finish</span> <span class="o">=</span> <span class="mi">1</span>
                     <span class="c1">#rospy.loginfo(finish)</span>
                     <span class="n">rotation_flag</span> <span class="o">=</span> <span class="mi">0</span>
                  
                  <span class="k">if</span> <span class="n">rotation_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
                     <span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span> <span class="o">-</span> <span class="mf">0.1</span>
                     <span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
                  <span class="k">elif</span> <span class="n">rotation_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                     <span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span> <span class="o">+</span> <span class="mf">0.1</span>
                     <span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span> </div></div>
       
        
        
                      

<span class="c1"># define state Recharge</span>
<div class="viewcode-block" id="Recharge"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Recharge">[docs]</a><span class="k">class</span> <span class="nc">Recharge</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class describe what happen when the state machine is in the Recharge state, to exit from this state the robot need to go in a defined room to recharge</span>
<span class="sd">    when the battery is full, the state can change</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span> <span class="o">=</span> <span class="n">Helper</span><span class="p">()</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;endmap&#39;</span><span class="p">,</span><span class="s1">&#39;battery_low&#39;</span><span class="p">,</span> <span class="s1">&#39;plan_ok&#39;</span><span class="p">,</span> <span class="s1">&#39;arrived&#39;</span><span class="p">,</span> <span class="s1">&#39;endtime&#39;</span><span class="p">,</span> <span class="s1">&#39;battery_ok&#39;</span><span class="p">],</span>
                             <span class="n">input_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;locked_counter_in&#39;</span><span class="p">],</span>
                             <span class="n">output_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;locked_counter_out&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="Recharge.execute"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.Recharge.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/planner_flag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/battery_flag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
                  
                  <span class="k">try</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span> <span class="o">==</span> <span class="n">BATTERY_OK</span><span class="p">:</span>
                         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">change_state</span>
                         <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/battery_flag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                         <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;Executing state Recharge&#39;</span><span class="p">)</span>
                  <span class="k">finally</span> <span class="p">:</span>   
                      <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                  <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span></div></div>
        
        
            
        
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../index.html#scripts.my_state_machine.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function initialize and run the state machine with its state and its transitions</span>
<span class="sd">    &#39;&#39;&#39;</span>
   
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;smach_state_machine&#39;</span><span class="p">)</span>
    

    <span class="c1"># Create a SMACH state machine</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;container_interface&#39;</span><span class="p">])</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">userdata</span><span class="o">.</span><span class="n">sm_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Open the container</span>
    <span class="k">with</span> <span class="n">sm</span><span class="p">:</span>
        <span class="c1"># Add states to the container</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;BUILDINGMAP&#39;</span><span class="p">,</span> <span class="n">Building_map</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;endmap&#39;</span><span class="p">:</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">,</span> 
                                            <span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;plan_ok&#39;</span><span class="p">:</span><span class="s1">&#39;BUILDINGMAP&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;arrived&#39;</span><span class="p">:</span><span class="s1">&#39;BUILDINGMAP&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="s1">&#39;BUILDINGMAP&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_ok&#39;</span><span class="p">:</span><span class="s1">&#39;BUILDINGMAP&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;locked_counter_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">,</span> 
                                          <span class="s1">&#39;locked_counter_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">})</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">,</span> <span class="n">Planner</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;endmap&#39;</span><span class="p">:</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;plan_ok&#39;</span><span class="p">:</span><span class="s1">&#39;CONTROLLER&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;arrived&#39;</span><span class="p">:</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_ok&#39;</span><span class="p">:</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;unlocked_counter_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;unlocked_counter_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">})</span>
         
                                                                   
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;CONTROLLER&#39;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;endmap&#39;</span><span class="p">:</span><span class="s1">&#39;CONTROLLER&#39;</span><span class="p">,</span> 
                                            <span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;plan_ok&#39;</span><span class="p">:</span><span class="s1">&#39;CONTROLLER&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;arrived&#39;</span><span class="p">:</span><span class="s1">&#39;WAIT&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="s1">&#39;CONTROLLER&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_ok&#39;</span><span class="p">:</span><span class="s1">&#39;CONTROLLER&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;locked_counter_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">,</span> 
                                          <span class="s1">&#39;locked_counter_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">})</span>
                                                                         
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;WAIT&#39;</span><span class="p">,</span> <span class="n">Wait</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;endmap&#39;</span><span class="p">:</span><span class="s1">&#39;WAIT&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;plan_ok&#39;</span><span class="p">:</span><span class="s1">&#39;WAIT&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;arrived&#39;</span><span class="p">:</span><span class="s1">&#39;WAIT&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_ok&#39;</span><span class="p">:</span><span class="s1">&#39;WAIT&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;locked_counter_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">,</span> 
                                          <span class="s1">&#39;locked_counter_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">})</span>                                  
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span> <span class="n">Recharge</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;endmap&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_low&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;plan_ok&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;arrived&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="s1">&#39;RECHARGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;battery_ok&#39;</span><span class="p">:</span><span class="s1">&#39;PLANNER&#39;</span><span class="p">},</span>
                               <span class="n">remapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;locked_counter_in&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">,</span> 
                                          <span class="s1">&#39;locked_counter_out&#39;</span><span class="p">:</span><span class="s1">&#39;sm_counter&#39;</span><span class="p">})</span>                                  
                                          


    <span class="c1"># Create and start the introspection server for visualization</span>
    <span class="n">sis</span> <span class="o">=</span> <span class="n">smach_ros</span><span class="o">.</span><span class="n">IntrospectionServer</span><span class="p">(</span><span class="s1">&#39;server_name&#39;</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="s1">&#39;/SM_ROOT&#39;</span><span class="p">)</span>
    <span class="n">sis</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Execute the state machine</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    
    
    

    <span class="c1"># Wait for ctrl-c to stop the application</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
    <span class="n">sis</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    
    <span class="n">main</span><span class="p">()</span>
    
    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Marco Limone.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>